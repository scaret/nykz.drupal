<?php
/**
 * åˆ—å‡ºå—æ´‹å®¢æ ˆå¸–å­åˆ—è¡¨
 */
function _nykzPost_resource_index($boardName, $start, $count){
  $posts = nykz_post_index($boardName,$start, $count);
  return $posts;
}

/**
 * è·å–æŸä¸ªå¸–å­
 */
function _nykzPost_resource_retrieve($boardName, $filename, $format = 'novt'){
  $the_post = nykz_post_load($boardName, $filename, $format);
  return $the_post;
}

/**
 * å‘è¡¨å¸–å­
 */
function _nykzPost_resource_create($boardName, $title, $content, $refilename){
  //return array($boardName, $title, $content, $refilename);
  global $user;
  $date = date("Yå¹´mæœˆdæ—¥ H:i:s");
  $weekarray=array("æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­");
  $date .= " æ˜ŸæœŸ".$weekarray[date("w")];
  $reply = "";
  $recontent = "";
  if($refilename){
    $refile = nykz_post_load($boardName, $refilename);
    if($refile){
      if($refile['match']){
        $reauthor = $refile['match']['author']." (".$refile['match']['nick'].")";
      }
      elseif($refile['index']){
        $reauthor = $refile['index']['owner']." (".$refile['index']['owner'].")";
      }
      $content_lines = split("\n", $refile['content']);
        foreach($content_lines as $key => $line){
          if($line == "--") break;
          if(substr($line, 0, 6) == ": : : ") continue;
          if( strlen($line) && $key > 3) $recontent .= "\n: ".$line;
        }
    }
  }
  if($recontent) $reply =<<<EOD
ã€ åœ¨ $reauthor çš„å¤§ä½œä¸­æåˆ°: ã€‘$recontent;
EOD;
  $body =<<<EOD
å‘ä¿¡äºº: $user->name ($user->name), ä¿¡åŒº: $boardName
æ ‡  é¢˜: $title
å‘ä¿¡ç«™: å—æ´‹å®¢æ ˆBBS ($date), å—æ´‹å®¢æ ˆå®¢æˆ·ç«¯

$content
$reply

--

[m[1;36mâ€» æ¥æº:Â·å—æ´‹å®¢æ ˆå®¢æˆ·ç«¯[m
EOD;
  if(!$title && $refile){
    $retitle = $refile['index']['title'];
    if(strpos("Re: ", $retitle)) $retitle = $title;
    else $title = "Re: ".$retitle;
  }
  $reid = $refile['index']['id'];
  $filename = nykz_post_create($boardName, $title, $body);
  return $filename;
}