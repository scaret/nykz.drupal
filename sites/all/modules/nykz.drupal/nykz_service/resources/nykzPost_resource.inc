<?php
/**
 * åˆ—å‡ºå—æ´‹å®¢æ ˆå¸–å­åˆ—è¡¨
 */
function _nykzPost_resource_index($boardName, $start, $count){
  $posts = nykz_post_index($boardName,$start, $count);
  return $posts;
}

/**
 * èŽ·å–æŸä¸ªå¸–å­
 */
function _nykzPost_resource_retrieve($boardName, $filename, $format = 'novt'){
  $the_post = nykz_post_load($boardName, $filename, $format);
  return $the_post;
}

/**
 * å‘è¡¨å¸–å­
 */
function _nykzPost_resource_create($boardName, $title = NULL, $content, $refilename){
  //return array($boardName, $title, $content, $refilename);
  global $user;
  $date = date("Yå¹´mæœˆdæ—¥ H:i:s");
  $weekarray=array("æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­");
  $date .= " æ˜ŸæœŸ".$weekarray[date("w")];
  $reply = "";
  $recontent = "";
  if($refilename){
    $refile = nykz_post_load($boardName, $refilename);
    if($refile){
      if($refile['match']){
        $reauthor = $refile['match']['author']." (".$refile['match']['nick'].")";
      }
      elseif($refile['index']){
        $reauthor = $refile['index']['owner']." (".$refile['index']['owner'].")";
      }
      if(!$title){
        $retitle = $refile['index']['title'];
        if(preg_match("/^Re:/i", $retitle, $matches)) $title = $retitle;
        else $title = "Re: ".$retitle;
      }
      $content_lines = explode("\n", $refile['content']);
        foreach($content_lines as $key => $line){
          if($line == "--") break;
          if(strlen($line) > 250 ) continue;
          if( strlen($line) && $key > 3) $recontent .= "\n: ".$line;
        }
    }
  }
  global $nykz_source_name;
  $ip_address = $_SERVER["REMOTE_ADDR"];
  if($recontent) $reply =<<<EOD
ã€ åœ¨ $reauthor çš„å¤§ä½œä¸­æåˆ°: ã€‘$recontent
EOD;
  $body =<<<EOD
å‘ä¿¡äºº: $user->name ($user->name), ä¿¡åŒº: $boardName
æ ‡  é¢˜: $title
å‘ä¿¡ç«™: å—æ´‹å®¢æ ˆBBS ($date), å—æ´‹å®¢æ ˆå®¢æˆ·ç«¯

$content
$reply

--

[m[1;36mâ€» æ¥æº:Â·$nykz_source_name nykz.netÂ·[FROM: $ip_address][m
EOD;
  if(isset($refile) && isset($refile['index']) && isset($refile['index']['reid']))
    $reid = $refile['index']['reid'];
  else
    $reid = NULL;
  $filename = nykz_post_create($boardName, $title, $body, $user->name, $reid);
  return $filename;
}
